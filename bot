user_memory = {}
user_limits = {}
MAX_MESSAGES = 30

import os

from dotenv import load_dotenv
from openai import OpenAI
from telegram import Update
from telegram.ext import ApplicationBuilder, MessageHandler, CommandHandler, ContextTypes, filters


load_dotenv()
OPENAI_KEY = os.getenv("OPENAI_API_KEY")
TG_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")

client = OpenAI(api_key=OPENAI_KEY)


SYSTEM_PROMPT = """
You are a helpful AI assistant in Telegram.
You help users with business, study, and daily tasks.
"""

PREDEFINED_ANSWERS = {
        "yung trappa": "блять иди нахуй ты co своей трапой габриэлла",
        "привет": "Доброго тебе дня. Чем помочь?",
        "помощь": "С чем именно тебе нужна помощь?",
        "цена": "Для обсуждения цен напишите в личку"}

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
        user_id = update.message.from_user.id
        if user_id in user_memory:
                user_memory[user_id] = []
        await update.message.reply_text("Hi. Let's work.")

async def handle_message(update: Update, context: ContextTypes.DEFAULT_TYPE):
        if not update.message or not update.message.text:
                return

        user_text = update.message.text
        user_text_lower = user_text.lower()
        user_id = update.message.from_user.id

        for key, reply in PREDEFINED_ANSWERS.items():
                if key.lower() in user_text_lower:
                        await update.message.reply_text(reply)
                        return

        #limits
        user_limits[user_id] = user_limits.get(user_id, 0) + 1

        if user_limits[user_id] > MAX_MESSAGES:
                await update.message.reply_text("You've reached your daily limit, waiting for you tomorrow!")
                return

        #creating user's memory
        if user_id not in user_memory:
                user_memory[user_id] = []

        user_memory[user_id].append({"role": "user", "content": user_text})

        try:
                messages = [{"role": "system", "content": SYSTEM_PROMPT}] + user_memory[user_id]

                response = client.chat.completions.create(
                        model = "gpt-4o-mini",
                        messages = messages
                )

                reply = response.choices[0].message.content

                user_memory[user_id].append({"role": "assistant", "content": reply})

                if len(user_memory[user_id]) > 20:
                        user_memory[user_id] = user_memory[user_id][-20:]

                await update.message.reply_text(reply)

        except Exception as e:
                await update.message.reply_text("Temporary error, please try again")
                print("ERROR: ", e)


def main():
        print("MAIN STARTED")

        app = ApplicationBuilder().token(TG_TOKEN).build()

        app.add_handler(CommandHandler("start", start))
        app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND, handle_message))

        print("Bot started!")
        app.run_polling()

if __name__ == "__main__":
        main()



